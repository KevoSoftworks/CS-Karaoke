package com.kevosoftworks.rpifpgaiface;

import java.io.IOException;

public class Main implements Runnable{
	
	static boolean running = false;
	Thread thread;
	boolean fast = false;
	boolean sanic = false;
	long timeStart;
	
	int totalLoops = 2000;
	
	SPIInterface si;
	
	public Main(boolean fast, boolean sanic){
		System.out.println("Lala");
		si = new SPIInterface(totalLoops);
		this.fast = fast;
		this.sanic = sanic;
	}

	@Override
	public void run() {
		timeStart = System.nanoTime();
		while(running){
			try {
				si.read();
			} catch (IOException | InterruptedException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
			try {
				if(!sanic)Thread.sleep(fast ? 1 : 500);
			} catch (InterruptedException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}
		long timeStop = System.nanoTime();
		long tt = timeStop - timeStart;
		long tpp = tt / totalLoops;
		System.out.println("Avg. time per packet: " + (tpp/1000) + "us; Total time: " + (tt/1000000) + "ms");
		System.out.println("Bits sent: " + 1024*8*totalLoops + "(" + (1024*totalLoops/1000) + "kb)");
	}
	
	public static void main(String[] args){
		boolean fast = false;
		boolean sanic = false;
		if(args.length == 1){
			fast = true;
			if(args.equals("sanic")) sanic = true;
		}
		new Main(fast, sanic).start();
	}
	
	public synchronized void start(){
		if(running) return;
		running = true;
		thread = new Thread(this);
		thread.start();
	}
	
	public synchronized void stop(){
		if(!running) return;
		running = false;
		try{
			thread.join();
		} catch(Exception e){
			e.printStackTrace();
		}
	}

}
